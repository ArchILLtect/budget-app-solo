import{c as X,u as x,k as q,j as e,i as B,F as D,H as G,K as C,t as A,B as c,d as H}from"./index-xwMjE7XY.js";import{r as p}from"./recharts-fUgtte1b.js";import{S as P}from"./select-CEgIQikT.js";import{I as J}from"./icon-button-BDXy_4vp.js";import{R as Y,D as Z}from"./Repeat-6plD-Uw_.js";import{T as _,a as ee,b as k,c as a,d as se,e as i}from"./tr-BC_ZfAu1.js";import{C as F}from"./checkbox-BpOi7ikZ.js";import{T as te}from"./tooltip-DWNPoC6y.js";import{B as u}from"./badge-f7PBaRE6.js";import"./use-form-control-B6IaQYr4.js";import"./split-CzYrjwZo.js";import"./create-icon-DM1WmCyW.js";import"./visually-hidden.style-Bfr07Aua.js";import"./omit-QLD0Eizt.js";import"./use-event-listener-BvnzY9DD.js";const M=X("div",{baseStyle:{flex:1,justifySelf:"stretch",alignSelf:"stretch"}});M.displayName="Spacer";function ne({status:j}){switch(j){case"active":return e.jsx(u,{colorScheme:"yellow",children:"Active"});case"expired":return e.jsx(u,{colorScheme:"gray",children:"Expired"});case"applied":return e.jsx(u,{colorScheme:"teal",children:"Applied"});case"partial-applied":return e.jsx(u,{colorScheme:"purple",children:"Partial Applied"});case"undone":return e.jsx(u,{colorScheme:"red",children:"Undone"});case"partial-undone":return e.jsx(u,{colorScheme:"orange",children:"Partial Undone"});default:return e.jsx(u,{children:"?"})}}function Se(){const j=x(s=>s.importHistory),g=x(s=>s.accounts),w=x(s=>s.getImportSessionRuntime),N=x(s=>s.undoStagedImport),z=x(s=>s.markTransactionsBudgetApplied),U=x(s=>s.processPendingSavingsForAccount),f=q(),[S,L]=p.useState(""),[v,O]=p.useState(""),[h,b]=p.useState({}),[V,E]=p.useState(Date.now());p.useEffect(()=>{const s=setInterval(()=>E(Date.now()),6e4);return()=>clearInterval(s)},[]);const d=p.useMemo(()=>j.map(s=>{const t=w(s.accountNumber,s.sessionId)||{stagedNow:0,appliedCount:0,removed:0,status:"?",canUndo:!1};return{entry:s,runtime:t}}).filter(s=>!(S&&s.entry.accountNumber!==S||v&&s.runtime.status!==v)),[j,S,v,V,w]),$=Object.values(h).some(s=>s),I=d.filter(s=>h[s.entry.sessionId]),m=s=>{const t={...h};d.forEach(o=>{o.runtime.status===s&&(t[o.entry.sessionId]=!0)}),b(t)},y=()=>b({}),K=s=>{const t={...h};d.forEach(o=>{t[o.entry.sessionId]=s}),b(t)},T=()=>{const s=[];I.forEach(({entry:t,runtime:o})=>{o.canUndo&&(N(t.accountNumber,t.sessionId),s.push(t.sessionId))}),f({title:"Undo complete",description:`${s.length} session(s) undone`,status:"info",duration:3e3})},R=()=>{let s=0;I.forEach(({entry:t,runtime:o})=>{if(o.status==="active"&&o.stagedNow>0){const r=g[t.accountNumber];if(!r?.transactions)return;const n=new Set;r.transactions.forEach(l=>{l.importSessionId===t.sessionId&&l.staged&&n.add(l.date.slice(0,7))}),n.size&&(z(t.accountNumber,[...n]),U(t.accountNumber,[...n]),s++)}}),f({title:"Apply complete",description:`${s} session(s) applied`,status:"success",duration:3e3})},Q=()=>{const s=["sessionId,account,newCount,staged,applied,removed,savingsCount,importedAt"];I.forEach(({entry:n,runtime:l})=>{s.push([n.sessionId,n.accountNumber,n.newCount,l.stagedNow,l.appliedCount,l.removed||0,n.savingsCount||0,n.importedAt].join(","))});const t=new Blob([s.join(`
`)],{type:"text/csv"}),o=URL.createObjectURL(t),r=document.createElement("a");r.href=o,r.download="import-sessions.csv",r.click(),URL.revokeObjectURL(o)},W=p.useMemo(()=>Object.keys(g),[g]);return e.jsxs(B,{p:6,children:[e.jsxs(D,{mb:4,align:"center",gap:4,wrap:"wrap",children:[e.jsx(G,{size:"md",children:"Import History"}),e.jsx(M,{}),e.jsxs(C,{children:[e.jsx(P,{size:"sm",placeholder:"Account",value:S,onChange:s=>L(s.target.value),children:W.map(s=>e.jsx("option",{value:s,children:s},s))}),e.jsxs(P,{size:"sm",placeholder:"Status",value:v,onChange:s=>O(s.target.value),children:[e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"expired",children:"Expired"}),e.jsx("option",{value:"applied",children:"Applied"}),e.jsx("option",{value:"partial-applied",children:"Partial Applied"}),e.jsx("option",{value:"undone",children:"Undone"}),e.jsx("option",{value:"partial-undone",children:"Partial Undone"})]}),e.jsx(J,{size:"sm","aria-label":"Refresh",icon:e.jsx(Y,{}),onClick:()=>E(Date.now())})]})]}),e.jsx(D,{mb:3,gap:2,wrap:"wrap",align:"center",children:$?e.jsxs(e.Fragment,{children:[e.jsxs(A,{fontSize:"sm",children:[I.length," selected"]}),e.jsx(c,{size:"xs",onClick:T,colorScheme:"red",variant:"outline",children:"Undo"}),e.jsx(c,{size:"xs",onClick:R,colorScheme:"teal",variant:"outline",children:"Apply"}),e.jsx(c,{size:"xs",onClick:()=>{T(),R()},variant:"outline",children:"Smart Resolve"}),e.jsx(c,{size:"xs",onClick:Q,leftIcon:e.jsx(Z,{}),variant:"outline",children:"Export CSV"}),e.jsx(c,{size:"xs",onClick:y,children:"Clear"})]}):e.jsxs(C,{spacing:2,children:[e.jsx(A,{fontSize:"xs",color:"gray.500",children:"Quick Select:"}),e.jsx(c,{size:"xs",variant:"ghost",onClick:()=>m("active"),children:"Active"}),e.jsx(c,{size:"xs",variant:"ghost",onClick:()=>m("expired"),children:"Expired"}),e.jsx(c,{size:"xs",variant:"ghost",onClick:()=>m("undone"),children:"Undone"}),e.jsx(c,{size:"xs",variant:"ghost",onClick:()=>m("partial-applied"),children:"Partial Applied"}),e.jsx(c,{size:"xs",variant:"ghost",onClick:()=>m("partial-undone"),children:"Partial Undone"})]})}),e.jsx(B,{borderWidth:1,borderRadius:"md",overflowX:"auto",children:e.jsxs(_,{size:"sm",variant:"striped",children:[e.jsx(ee,{children:e.jsxs(k,{children:[e.jsx(a,{children:e.jsx(F,{isChecked:d.length>0&&d.every(s=>h[s.entry.sessionId]),onChange:s=>K(s.target.checked)})}),e.jsx(a,{children:"Session"}),e.jsx(a,{children:"Account"}),e.jsx(a,{children:"Imported"}),e.jsx(a,{children:"New"}),e.jsx(a,{children:"Staged"}),e.jsx(a,{children:"Applied"}),e.jsx(a,{children:"Removed"}),e.jsx(a,{children:"Savings"}),e.jsx(a,{children:"Status"}),e.jsx(a,{children:"Undo In"}),e.jsx(a,{children:"Actions"})]})}),e.jsxs(se,{children:[d.map(({entry:s,runtime:t})=>{const o=t.expiresAt?Math.max(0,Math.ceil((t.expiresAt-Date.now())/6e4)):0;return e.jsxs(k,{children:[e.jsx(i,{children:e.jsx(F,{isChecked:!!h[s.sessionId],onChange:r=>b(n=>({...n,[s.sessionId]:r.target.checked}))})}),e.jsx(i,{title:s.hash,children:s.sessionId.slice(0,8)}),e.jsx(i,{children:s.accountNumber}),e.jsx(i,{children:e.jsx(te,{label:s.importedAt,children:H(s.importedAt).fromNow?.()||H(s.importedAt).format("MMM D HH:mm")})}),e.jsx(i,{children:s.newCount}),e.jsx(i,{children:t.stagedNow}),e.jsx(i,{children:t.appliedCount}),e.jsx(i,{children:t.removed||0}),e.jsx(i,{children:s.savingsCount||0}),e.jsx(i,{children:e.jsx(ne,{status:t.status})}),e.jsx(i,{children:t.status==="active"?o+"m":"-"}),e.jsx(i,{children:e.jsxs(C,{spacing:1,children:[e.jsx(c,{size:"xs",variant:"outline",isDisabled:!t.canUndo,onClick:()=>{t.canUndo&&(N(s.accountNumber,s.sessionId),f({title:"Session undone",status:"info"}))},children:"Undo"}),e.jsx(c,{size:"xs",variant:"outline",isDisabled:!(t.status==="active"&&t.stagedNow>0),onClick:()=>{const r=g[s.accountNumber];if(!r?.transactions)return;const n=new Set;r.transactions.forEach(l=>{l.importSessionId===s.sessionId&&l.staged&&n.add(l.date.slice(0,7))}),z(s.accountNumber,[...n]),U(s.accountNumber,[...n]),f({title:"Session applied",status:"success"})},children:"Apply"})]})})]},s.sessionId)}),d.length===0&&e.jsx(k,{children:e.jsx(i,{colSpan:12,children:e.jsx(A,{fontSize:"sm",color:"gray.500",textAlign:"center",py:6,children:"No import sessions match filters."})})})]})]})})]})}export{Se as default};
