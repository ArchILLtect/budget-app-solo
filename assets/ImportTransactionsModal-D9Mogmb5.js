import{k as Qe,u as j,j as e,N as Me,O as Fe,Q as Re,R as Te,M as Ve,l as Ue,p as Ye,q as _e,r as qe,V as Ke,t as c,K as v,B as d,i as x,v as Ge}from"./index-xwMjE7XY.js";import{r as a}from"./recharts-fUgtte1b.js";import{p as Je,r as Xe}from"./runIngestion-B6P9gsVO.js";import{P as Ze,I as es}from"./IngestionMetricsPanel-Csc5pPPM.js";import{M as ss}from"./modal-close-button-V6F9r3JT.js";import{F as fe}from"./use-form-control-B6IaQYr4.js";import{F as xe}from"./form-label-Cqg8IcOd.js";import{I as De}from"./input-QV5FdPZP.js";import{S as ts}from"./select-CEgIQikT.js";import{B as E}from"./badge-f7PBaRE6.js";import{S as $,a as B,b as O}from"./stat-number-O1IGy_6B.js";import{D as Se}from"./divider-B1h1HTXB.js";import"./accountUtils-C7DJjkh9.js";import"./AccountsTrackerPage-Dy7munrn.js";import"./tooltip-DWNPoC6y.js";import"./create-icon-DM1WmCyW.js";import"./use-event-listener-BvnzY9DD.js";import"./omit-QLD0Eizt.js";import"./tab-panels-hxep4z5W.js";import"./__vite-browser-external-3a0vqkmD.js";import"./tr-BC_ZfAu1.js";import"./center-CIAJU8Ix.js";import"./LoadingSpinner-BAAFQNyv.js";import"./stat-help-text-LexhNEvj.js";import"./split-CzYrjwZo.js";function rs(ne,oe={}){const{onRow:g=()=>{},onProgress:Y=()=>{},onComplete:_=()=>{},header:q=!0,preview:ae,chunkSize:f=1024*64}=oe;let S=0,z=!1;const W=[],A=[];let y=null;const k={abort:()=>{if(z=!0,y&&y.abort)try{y.abort()}catch{}}};return Ze.parse(ne,{header:q,preview:ae,skipEmptyLines:!0,worker:!1,chunkSize:f,chunk:(h,l)=>{if(y||(y=l),z){l.abort();return}for(const b of h.data){q?b.__line=S+2:b.__line=S+1;const H=g(b,S);if(W.push(b),S++,H===!1){z=!0,l.abort();break}}Y({rows:S,bytes:null,finished:!1})},complete:h=>{if(h&&h.errors&&h.errors.length)for(const l of h.errors)A.push({line:l.row+1,message:l.message});Y({rows:S,bytes:null,finished:!0}),_({rows:W,meta:{rowCount:S,aborted:z,parseErrors:A}})},error:h=>{A.push({line:null,message:h?.message||"Streaming parse error"}),_({error:h,rows:W,meta:{rowCount:S,aborted:z,parseErrors:A}})}}),k}function Fs({isOpen:ne,onClose:oe}){const g=Qe(),Y=j(s=>s.accounts),_=j(s=>s.importManifests||{}),q=j(s=>s.registerImportManifest),ae=j(s=>s.setLastIngestionTelemetry),f=j(s=>s.lastIngestionTelemetry),S=j.setState,z=j(s=>s.streamingAutoLineThreshold),W=j(s=>s.streamingAutoByteThreshold),[A,y]=a.useState(""),[k,h]=a.useState(""),[l,b]=a.useState(""),[H,ie]=a.useState([]),[le,K]=a.useState(!1),[L,G]=a.useState(!1),[Ee,ce]=a.useState(!1),[I,J]=a.useState(!1),[M,de]=a.useState(0),[Q,ue]=a.useState(!1),[X,V]=a.useState(!1),[je,Z]=a.useState(""),[w,pe]=a.useState(!1),[be,me]=a.useState(null),[t,he]=a.useState(null),[F,ee]=a.useState(!1),[C,U]=a.useState(!1),[R,we]=a.useState(null),[ye,ke]=a.useState(!1),[P,se]=a.useState("all"),[te,Ce]=a.useState({parseMs:null,ingestMs:null,totalMs:null}),ge=a.useRef(!1),Le=()=>{y(""),h(""),b(""),ie([]),K(!1),G(!1),he(null),ee(!1),ce(!1),J(!1),de(0),ue(!1),V(!1),Z(""),pe(!1),me(null)},ve=Y[l]?.transactions||[],Pe=a.useCallback(s=>{try{const r=Je(s),n=Array.isArray(r)?r:r.rows;if(!n.length)return[];const o=new Set;for(let i=0;i<n.length&&i<800;i++){const m=n[i],u=(m.AccountNumber||m.accountNumber||"").toString().trim();u&&o.add(u)}return[...o]}catch{return[]}},[]),Ne=s=>{const r=s.target.files?.[0];if(!r)return;y(r.name),he(null),ee(!1),ie([]),K(!1),J(!1),V(!1),Z("");const n=new FileReader;n.onload=o=>{const i=o.target.result||"";h(i);try{we((i.match(/\n/g)||[]).length+1||null)}catch{we(null)}const m=Pe(i);try{const u=(i.match(/\n/g)||[]).length+1,p=r.size||i.length,T=z||3e3,N=W||5e5;if(!I&&(u>T||p>N)){J(!0),V(!0);const D=[];u>T&&D.push(`${u.toLocaleString()} lines`),p>N&&D.push(`${(p/1024).toFixed(1)} KB`),Z(`Large file: ${D.join(", ")}`)}}catch{}m.length===1?(b(u=>u||m[0]),K(!0)):m.length>1&&ie(m)},n.readAsText(r)},$e=async()=>{if(!k){g({title:"No file selected",status:"warning",duration:2200});return}if(!l){g({title:"Account number required",status:"warning",duration:2500});return}G(!0),ce(!1);try{const s=performance&&performance.now?performance.now():Date.now();let r={fileText:k};if(I){ce(!0),de(0),ue(!1),pe(!1);const i=performance&&performance.now?performance.now():Date.now(),m=await new Promise((p,T)=>{try{const N=rs(k,{onRow:()=>!0,onProgress:({rows:D,finished:re})=>{de(D),re&&ue(!0)},onComplete:({rows:D,meta:re,error:Ie})=>{me(null),Ie?T(Ie):p(w?{rows:[],errors:re?.parseErrors||[]}:{rows:D,errors:re?.parseErrors||[]})}});me(N)}catch(N){T(N)}}),u=performance&&performance.now?performance.now():Date.now();if(w){g({title:"Streaming aborted",description:`${M} rows parsed (ignored).`,status:"warning",duration:3e3}),G(!1);return}r={parsedRows:m},Ce(p=>({...p,parseMs:+(u-i).toFixed(2)}))}const n=await Xe({...r,accountNumber:l,existingTxns:ve,registerManifest:q});he(n),ee(!1);try{ae({at:new Date().toISOString(),accountNumber:l,hash:n.stats.hash,newCount:n.stats.newCount,dupesExisting:n.stats.dupesExisting,dupesIntraFile:n.stats.dupesIntraFile,categorySources:n.stats.categorySources})}catch{}const o=performance&&performance.now?performance.now():Date.now();Ce(i=>({...i,ingestMs:n.stats.ingestMs,totalMs:+(o-s).toFixed(2)})),g({title:"Dry run complete",description:`New: ${n.stats.newCount} | DupEx: ${n.stats.dupesExisting} | DupIntra: ${n.stats.dupesIntraFile} | Ingest: ${n.stats.ingestMs}ms`+(te.parseMs?` | Parse: ${te.parseMs}ms`:""),status:"info",duration:3500})}catch(s){g({title:"Ingestion failed",description:s.message,status:"error"})}finally{G(!1)}},Be=()=>{if(be){pe(!0);try{be.abort()}catch{}}},Oe=j(s=>s.addPendingSavingsQueue),We=j(s=>s.recordImportHistory),ze=()=>{if(t?.patch)try{S(t.patch),ee(!0),U(!1);const s=t.stats.importSessionId||t.importSessionId;g({title:"Import applied (staged)",description:"Transactions are staged until you Apply to Budget.",status:"success",duration:3e3}),We({sessionId:s,accountNumber:l,importedAt:new Date().toISOString(),newCount:t.stats.newCount,dupesExisting:t.stats.dupesExisting,dupesIntraFile:t.stats.dupesIntraFile,savingsCount:t.savingsQueue?.length||0,hash:t.stats.hash}),t.savingsQueue&&t.savingsQueue.length&&(Oe(l,t.savingsQueue),g({title:"Savings deferred",description:`${t.savingsQueue.length} potential savings transactions will be reviewed after budget apply.`,status:"info",duration:4e3}))}catch(s){g({title:"Apply failed",description:s.message,status:"error"})}},Ae=()=>{oe(),setTimeout(Le,200)},He=t?(()=>{const s=_[t.stats.hash],r=s?.accounts?.[l];return!s||!r?null:e.jsxs(Me,{status:"warning",borderRadius:"md",mb:3,children:[e.jsx(Fe,{}),e.jsx(Re,{fontSize:"sm",mr:2,children:"Previously Imported"}),e.jsxs(Te,{fontSize:"xs",children:["This file hash was imported for this account at ",r.importedAt,". Re-importing may be redundant."]})]})})():null;return e.jsxs(Ve,{isOpen:ne,onClose:Ae,size:"4xl",scrollBehavior:"inside",children:[e.jsx(Ue,{}),e.jsxs(Ye,{children:[e.jsx(_e,{children:"Import Transactions"}),e.jsx(ss,{}),e.jsx(qe,{children:e.jsxs(Ke,{align:"stretch",spacing:4,children:[e.jsxs(fe,{children:[e.jsx(xe,{fontSize:"sm",children:"CSV File"}),e.jsx(De,{type:"file",size:"sm",accept:".csv,text/csv",onChange:Ne}),A&&e.jsx(c,{fontSize:"xs",mt:1,children:A})]}),H.length>1&&e.jsxs(fe,{children:[e.jsx(xe,{fontSize:"sm",children:"Detected Accounts"}),e.jsx(ts,{size:"sm",value:l,placeholder:"Select account",onChange:s=>b(s.target.value),children:H.map(s=>e.jsx("option",{value:s,children:s},s))}),e.jsx(c,{fontSize:"xs",mt:1,children:"Multiple AccountNumber values found in file."})]}),H.length===0&&e.jsxs(fe,{children:[e.jsxs(xe,{fontSize:"sm",children:["Account Number ",le&&"(Auto-detected)"]}),e.jsx(De,{size:"sm",value:l,placeholder:"Enter or auto-detected",isDisabled:le,onChange:s=>{b(s.target.value),K(!1)}}),le&&e.jsx(c,{fontSize:"xs",mt:1,children:"Derived from AccountNumber column."})]}),e.jsxs(v,{children:[e.jsx(d,{size:"sm",colorScheme:"teal",onClick:$e,isLoading:L,isDisabled:!k,children:"Run Dry Run"}),e.jsxs(v,{spacing:2,children:[e.jsx(d,{size:"sm",variant:I?"solid":"outline",colorScheme:I?"purple":"gray",onClick:()=>J(s=>{const r=!s;return r?V(!1):(V(!1),Z("")),r}),disabled:L,title:X?`Auto-enabled: ${je}`:"Toggle streaming parser",children:I?X?"Streaming AUTO":"Streaming ON":"Streaming OFF"}),X&&e.jsx(E,{colorScheme:"purple",variant:"subtle",fontSize:"0.6rem",children:"auto"})]}),!C&&e.jsx(d,{size:"sm",variant:"outline",onClick:()=>U(!0),isDisabled:!t?.patch||F,children:"Review & Apply"}),C&&e.jsx(d,{size:"sm",colorScheme:"green",onClick:ze,isDisabled:F,children:"Confirm Apply"}),C&&e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>U(!1),isDisabled:F,children:"Cancel"}),F&&e.jsx(E,{colorScheme:"green",children:"Applied"}),L&&Ee&&!Q&&!w&&e.jsx(d,{size:"sm",colorScheme:"red",variant:"outline",onClick:Be,children:"Abort"})]}),L&&I&&e.jsxs(x,{w:"100%",borderWidth:1,borderRadius:"md",p:2,bg:"gray.50",children:[e.jsxs(v,{justify:"space-between",fontSize:"xs",children:[e.jsx(c,{children:"Streaming parse..."}),e.jsxs(v,{spacing:3,children:[e.jsxs(c,{children:[M," rows",R?` / ${R.toLocaleString()}`:""]}),R&&e.jsxs(E,{colorScheme:w?"red":Q?"green":"purple",children:[Math.min(100,M/R*100||0).toFixed(1),"%"]}),w&&e.jsx(E,{colorScheme:"red",children:"aborted"})]})]}),e.jsx(x,{mt:1,h:"4px",bg:"gray.200",borderRadius:"sm",overflow:"hidden",children:(()=>{let s=0;return R&&R>0?s=Math.min(100,M/R*100):Q?s=100:s=10+Math.min(50,M/50),e.jsx(x,{h:"100%",width:`${Q||w?100:s}%`,transition:"width 0.4s ease",bg:w?"red.400":Q?"green.400":"purple.400"})})()})]}),X&&!L&&!t&&e.jsxs(c,{fontSize:"10px",color:"purple.600",children:["Streaming auto-enabled (",je,"). You can toggle it off."]}),t&&e.jsxs(x,{borderWidth:1,borderRadius:"md",p:3,bg:"gray.50",children:[e.jsxs(v,{spacing:6,flexWrap:"wrap",children:[e.jsxs($,{children:[e.jsx(B,{children:"New"}),e.jsx(O,{children:t.stats.newCount})]}),e.jsxs($,{children:[e.jsx(B,{children:"Total Dupes"}),e.jsx(O,{children:t.stats.dupesExisting+t.stats.dupesIntraFile})]}),e.jsxs($,{children:[e.jsx(B,{children:"Existing"}),e.jsx(O,{children:t.stats.dupesExisting})]}),e.jsxs($,{children:[e.jsx(B,{children:"Intra-file"}),e.jsx(O,{children:t.stats.dupesIntraFile})]}),e.jsxs($,{children:[e.jsx(B,{children:"Errors"}),e.jsx(O,{children:t.errors.length})]}),e.jsxs($,{children:[e.jsx(B,{children:"Hash"}),e.jsx(O,{fontSize:"sm",children:t.stats.hash})]})]}),e.jsx(Se,{my:3}),e.jsx(es,{metrics:t?.stats?{ingestMs:t.stats.ingestMs,parseMs:te.parseMs,processMs:t.stats.processMs,totalMs:te.totalMs,rowsProcessed:t.stats.rowsProcessed,rowsPerSec:t.stats.rowsPerSec,duplicatesRatio:t.stats.duplicatesRatio,stageTimings:t.stats.stageTimings,earlyShortCircuits:t.stats.earlyShortCircuits}:null,sessionId:t?.stats?.importSessionId}),e.jsx(Se,{my:3}),C&&e.jsxs(x,{mb:3,p:3,borderWidth:1,borderRadius:"md",bg:"yellow.50",children:[e.jsx(c,{fontSize:"sm",fontWeight:"semibold",mb:2,children:"Confirmation Summary"}),e.jsxs(c,{fontSize:"xs",mb:1,children:["You are about to apply ",e.jsx("strong",{children:t.stats.newCount})," new transactions to account ",e.jsx("strong",{children:l}),"."]}),e.jsxs(c,{fontSize:"xs",mb:1,children:["Existing duplicates skipped: ",t.stats.dupesExisting," | Intra-file skipped: ",t.stats.dupesIntraFile]}),t.stats.categorySources&&e.jsxs(x,{mt:2,mb:2,children:[e.jsx(c,{fontSize:"xs",fontWeight:"semibold",children:"Category Inference Sources"}),(()=>{const s=Object.values(t.stats.categorySources).reduce((n,o)=>n+o,0)||1,r={provided:"Category supplied in CSV (non-uncategorized).",keyword:"Matched a configured keyword substring.",regex:"Matched a regex rule pattern.",consensus:"Assigned via vendor consensus (dominant category among labeled samples).",none:"No category inferred (remains unlabeled)."};return e.jsx(v,{spacing:3,mt:1,wrap:"wrap",children:Object.entries(t.stats.categorySources).map(([n,o])=>{const i=(o/s*100).toFixed(1);return e.jsxs(E,{title:r[n]||n,colorScheme:n==="none"?"gray":n==="consensus"?"purple":"blue",fontSize:"0.6rem",children:[n,": ",o," (",i,"%)"]},n)})})})()]}),e.jsx(c,{fontSize:"xs",mb:2,children:"First 5 new transactions:"}),e.jsx(x,{fontFamily:"mono",fontSize:"10px",maxH:"120px",overflowY:"auto",bg:"gray.800",color:"green.200",p:2,borderRadius:"sm",children:t.acceptedTxns.slice(0,5).map(s=>e.jsxs(c,{children:[s.date," | ",(s.rawAmount??s.amount).toFixed(2)," | ",s.type," | ",s.category||"—"," | ",s.description.slice(0,60)]},s.id))})]}),He,t.errors.length>0&&e.jsxs(x,{mb:2,children:[e.jsxs(Me,{status:"warning",borderRadius:"md",mb:2,children:[e.jsx(Fe,{}),e.jsx(Re,{fontSize:"sm",mr:2,children:"Row Errors"}),e.jsxs(Te,{fontSize:"xs",children:[t.errors.length," rows skipped."]})]}),(()=>{const s={all:t.errors.length,parse:t.errors.filter(r=>r.type==="parse").length,normalize:t.errors.filter(r=>r.type==="normalize").length,duplicate:t.errors.filter(r=>r.type==="duplicate").length};return e.jsxs(v,{spacing:2,mb:1,wrap:"wrap",children:[e.jsxs(d,{size:"xs",variant:P==="all"?"solid":"outline",onClick:()=>se("all"),children:["All (",s.all,")"]}),e.jsxs(d,{size:"xs",variant:P==="parse"?"solid":"outline",onClick:()=>se("parse"),children:["Parse (",s.parse,")"]}),e.jsxs(d,{size:"xs",variant:P==="normalize"?"solid":"outline",onClick:()=>se("normalize"),children:["Normalize (",s.normalize,")"]}),e.jsxs(d,{size:"xs",variant:P==="duplicate"?"solid":"outline",onClick:()=>se("duplicate"),children:["Duplicate (",s.duplicate,")"]}),e.jsx(d,{size:"xs",onClick:()=>ke(r=>!r),children:ye?"Hide":"Show"}),e.jsx(d,{size:"xs",variant:"ghost",title:"Download errors as CSV",onClick:()=>{if(!ge.current){ge.current=!0,setTimeout(()=>{ge.current=!1},1500);try{const r="line,type,reason,message",n=t.errors.map(p=>[p.line,p.type,p.reason||"",(p.message||"").replace(/"/g,'""')]),o=[r,...n.map(p=>p.map(T=>`"${(T??"").toString().replace(/"/g,'""')}"`).join(","))].join(`
`);o.length>2e6&&g({title:"Large CSV",description:"Generating large error export...",status:"info",duration:2e3});const i=new Blob([o],{type:"text/csv"}),m=URL.createObjectURL(i),u=document.createElement("a");u.href=m,u.download=`ingestion-errors-${t.stats.hash}.csv`,document.body.appendChild(u),u.click(),setTimeout(()=>{URL.revokeObjectURL(m),u.remove()},0)}catch{}}},children:"Download CSV"}),e.jsx(d,{size:"xs",variant:"ghost",title:"Legend: duplicate=yellow, normalize=red, parse=orange",disabled:!0,children:"Legend"})]})})(),ye&&e.jsx(x,{maxH:"160px",overflowY:"auto",borderWidth:1,borderRadius:"md",p:2,bg:"gray.900",color:"red.200",fontFamily:"mono",fontSize:"10px",children:t.errors.filter(r=>P==="all"||r.type===P).slice(0,200).map((r,n)=>{let o;return r.type==="duplicate"?o="yellow.300":r.type==="normalize"?o="red.200":r.type==="parse"?o="orange.300":o="red.200",e.jsxs(c,{color:o,children:["L",r.line||"?"," [",r.type||"unknown","] ",r.message]},n)})})]}),e.jsx(Se,{my:3}),f&&!C&&e.jsxs(x,{mb:3,p:2,borderWidth:1,borderRadius:"md",bg:"blue.50",children:[e.jsx(c,{fontSize:"xs",fontWeight:"semibold",mb:1,children:"Last Import Telemetry"}),e.jsxs(c,{fontSize:"10px",mb:1,children:["At: ",f.at," | Account: ",f.accountNumber," | New: ",f.newCount," | DupEx: ",f.dupesExisting," | DupIntra: ",f.dupesIntraFile]}),f.categorySources&&e.jsx(v,{spacing:2,wrap:"wrap",children:Object.entries(f.categorySources).map(([s,r])=>{const n=Object.values(f.categorySources).reduce((i,m)=>i+m,0)||1,o=(r/n*100).toFixed(1);return e.jsxs(E,{fontSize:"0.55rem",colorScheme:s==="none"?"gray":s==="consensus"?"purple":"blue",children:[s,":",r," (",o,"%)"]},s)})})]}),e.jsx(c,{fontSize:"xs",color:"gray.600",children:"Preview of accepted (first 10)"}),e.jsx(x,{mt:1,maxH:"180px",overflowY:"auto",fontFamily:"mono",fontSize:"xs",p:2,borderWidth:1,borderRadius:"md",bg:"gray.800",color:"green.200",children:(()=>{const s={accounts:{[l]:{transactions:ve}}};return(t.patch(s).accounts[l].transactions||[]).slice(0,10).map(o=>e.jsxs(c,{children:[o.date," | ",(o.rawAmount??o.amount).toFixed(2)," | ",o.type," | ",o.category||"—"," | ",o.description.slice(0,50)]},o.id))})()})]}),t&&I&&!L&&e.jsx(E,{colorScheme:w?"red":"purple",alignSelf:"flex-start",children:w?`Aborted after ${M}`:`Streamed ${M} rows`})]})}),e.jsxs(Ge,{children:[e.jsx(d,{mr:3,onClick:Ae,children:"Close"}),!C&&e.jsx(d,{colorScheme:"blue",onClick:()=>U(!0),isDisabled:!t?.patch||F,children:"Review & Apply"}),C&&e.jsx(d,{colorScheme:"green",onClick:ze,isDisabled:F,children:"Confirm Apply"}),C&&e.jsx(d,{variant:"ghost",onClick:()=>U(!1),isDisabled:F,children:"Cancel"})]})]})]})}export{Fs as default};
