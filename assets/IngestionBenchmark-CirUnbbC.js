import{k as he,j as e,F as A,K as x,H as U,i as d,V as H,t as u,B as y}from"./index-xwMjE7XY.js";import{r as g}from"./recharts-fUgtte1b.js";import{S as me,r as _}from"./runIngestion-B6P9gsVO.js";import{B as f}from"./badge-f7PBaRE6.js";import{T as B}from"./tooltip-DWNPoC6y.js";import{I as se}from"./icon-button-BDXy_4vp.js";import{c as te}from"./create-icon-DM1WmCyW.js";import{C as xe}from"./__vite-browser-external-3a0vqkmD.js";import{C as fe}from"./collapse-CgUcSxe4.js";import{I}from"./input-QV5FdPZP.js";import{C as je}from"./checkbox-BpOi7ikZ.js";import{R as be,D as Se}from"./Repeat-6plD-Uw_.js";import{D as ye}from"./divider-B1h1HTXB.js";import"./accountUtils-C7DJjkh9.js";import"./use-event-listener-BvnzY9DD.js";import"./omit-QLD0Eizt.js";import"./use-form-control-B6IaQYr4.js";import"./visually-hidden.style-Bfr07Aua.js";const we=te({d:"M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z",displayName:"ChevronUpIcon"}),Ce=te({displayName:"CloseIcon",d:"M.439,21.44a1.5,1.5,0,0,0,2.122,2.121L11.823,14.3a.25.25,0,0,1,.354,0l9.262,9.263a1.5,1.5,0,1,0,2.122-2.121L14.3,12.177a.25.25,0,0,1,0-.354l9.263-9.262A1.5,1.5,0,0,0,21.439.44L12.177,9.7a.25.25,0,0,1-.354,0L2.561.44A1.5,1.5,0,0,0,.439,2.561L9.7,11.823a.25.25,0,0,1,0,.354Z"});function He({onRequestClose:ne}){const[M,J]=g.useState("1000,5000,10000"),[w,V]=g.useState(.1),[C,W]=g.useState(.05),[k,G]=g.useState(2),[E,K]=g.useState("BENCH"),[v,D]=g.useState([]),[h,R]=g.useState(!1),[j,Y]=g.useState(!1),[N,re]=g.useState(!1),[m,L]=g.useState([]),[O,oe]=g.useState(""),[F,ae]=g.useState(""),[q,T]=g.useState(null),Z="ingestionBaselineSnapshots";g.useEffect(()=>{try{const s=localStorage.getItem(Z);if(s){const r=JSON.parse(s);Array.isArray(r)&&L(r)}}catch{}},[]);function Q(s){try{localStorage.setItem(Z,JSON.stringify(s))}catch{}}function ie(){try{const s=m.find(i=>i.at===O),r=m.find(i=>i.at===F);if(!s||!r){T(null);return}const t=new Set([...Object.keys(s.sizes||{}),...Object.keys(r.sizes||{})]),n=["wallMs","ingestMs","processMs","rowsPerSec","duplicatesRatio"],c={};t.forEach(i=>{c[i]={},n.forEach(l=>{const o=s.sizes[i]?.[l],a=r.sizes[i]?.[l];if(o===void 0&&a===void 0)return;const p=o!==void 0&&a!==void 0&&o!==0?+((a-o)/o*100).toFixed(2):null;c[i][l]={a:o,b:a,deltaPct:p}})}),T(c)}catch{T(null)}}const b=he();function le(){h||(J("1000,5000,10000"),V(.1),W(.05),G(2),K("BENCH"),D([]),Y(!1),b({title:"Benchmark settings reset",status:"info",duration:1800}))}const ce=e.jsxs(A,{px:4,py:2,align:"center",justify:"space-between",bg:"gray.400",borderBottom:"1px solid",borderColor:"gray.800",children:[e.jsxs(x,{spacing:3,children:[e.jsx(U,{size:"xs",letterSpacing:"wider",color:"gray.800",children:"Ingestion Benchmark (Dev)"}),h&&e.jsx(f,{colorScheme:"purple",children:"RUNNING"}),!h&&v.length>0&&e.jsx(f,{colorScheme:"teal",children:"DONE"})]}),e.jsxs(x,{spacing:1,children:[e.jsx(B,{label:N?"Expand panel":"Collapse panel",children:e.jsx(se,{"aria-label":"collapse",size:"xs",variant:"ghost",colorScheme:"purple",icon:N?e.jsx(we,{}):e.jsx(xe,{}),onClick:()=>re(s=>!s)})}),e.jsx(B,{label:"Close benchmark panel",children:e.jsx(se,{"aria-label":"close",size:"xs",variant:"ghost",colorScheme:"red",icon:e.jsx(Ce,{boxSize:2}),onClick:()=>{ne?.()}})})]})]});function X(s,r){const t=Math.max(1,Math.floor(s*(1-r))),n=s-t,c="date,description,amount",i=[];for(let a=0;a<t;a++){const z=`2025-01-${(a%28+1).toString().padStart(2,"0")}`,S=`Test Vendor ${(a%200).toString().padStart(3,"0")}`,$=a%500+1,P=(a%2===0?1:-1)*$;i.push(`${z},${S},${P.toFixed(2)}`)}const l=[];for(let a=0;a<n;a++){const p=i[a%i.length];l.push(p)}const o=i.concat(l);for(let a=o.length-1;a>0;a--){const p=(a*9301+49297)%233280%(a+1);[o[a],o[p]]=[o[p],o[a]]}return c+`
`+o.join(`
`)}function ee(s,r){if(r<=0)return[];const t=s.split(/\n/).slice(1),n=Math.floor(t.length*r);return t.slice(0,n).map((i,l)=>{const[o,a,p]=i.split(","),z=Math.abs(Number(p)),S=Number(p);return{id:`existing-${l}-${o}-${a}`,date:o,description:a,amount:z,rawAmount:S,type:S>=0?"income":"expense",category:void 0}})}async function de(){if(!h){D([]),R(!0);try{const s=M.split(",").map(t=>parseInt(t.trim(),10)).filter(t=>t>0),r=[];for(const t of s){const n=X(t,w),c=ee(n,C);for(let i=1;i<=k;i++){const l=performance.now();let o;if(j){const p=n.split(/\n/).slice(1).map((z,S)=>{const[$,P,ge]=z.split(",");return{date:$,description:P,amount:ge,__line:S+2}});o=await _({parsedRows:{rows:p,errors:[]},accountNumber:E,existingTxns:c,registerManifest:()=>{}})}else o=await _({fileText:n,accountNumber:E,existingTxns:c,registerManifest:()=>{}});const a=performance.now();r.push({id:`${t}-${i}-${Date.now()}`,size:t,iteration:i,wallMs:+(a-l).toFixed(2),ingestMs:o.stats.ingestMs,processMs:o.stats.processMs,rowsPerSec:o.stats.rowsPerSec,duplicatesRatio:o.stats.duplicatesRatio,dupesExisting:o.stats.dupesExisting,dupesIntraFile:o.stats.dupesIntraFile,errors:o.errors.length,streamSim:j,stageTimings:o.stats.stageTimings}),D(p=>[...p,...r.slice(-1)])}}b({title:"Benchmark complete",status:"success",duration:3e3})}catch(s){b({title:"Benchmark failed",description:s.message,status:"error"})}finally{R(!1)}}}function ue(){try{const s=new Blob([JSON.stringify({at:new Date().toISOString(),config:{sizesInput:M,intraDupFrac:w,existingDupFrac:C,iterations:k,streamSim:j},results:v},null,2)],{type:"application/json"}),r=URL.createObjectURL(s),t=document.createElement("a");t.href=r,t.download=`ingestion-benchmark-${Date.now()}.json`,document.body.appendChild(t),t.click(),setTimeout(()=>{URL.revokeObjectURL(r),t.remove()},0)}catch{}}async function pe(){if(h)return;R(!0);const s=[5e3,1e4,6e4,1e5],r={at:new Date().toISOString(),sizes:{},config:{intraDupFrac:w,existingDupFrac:C,streamSim:j}};try{for(const t of s){const n=X(t,w),c=ee(n,C),i=performance.now(),l=await _({fileText:n,accountNumber:"BASELINE",existingTxns:c,registerManifest:()=>{}}),o=performance.now();r.sizes[t]={wallMs:+(o-i).toFixed(2),ingestMs:l.stats.ingestMs,processMs:l.stats.processMs,rowsPerSec:l.stats.rowsPerSec,duplicatesRatio:l.stats.duplicatesRatio,newCount:l.stats.newCount,dupesExisting:l.stats.dupesExisting,dupesIntraFile:l.stats.dupesIntraFile,earlyShortCircuits:l.stats.earlyShortCircuits||null}}L(t=>{const n=[...t,r];return Q(n),n});try{const t=new Blob([JSON.stringify(r,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),c=document.createElement("a");c.href=n,c.download=`ingestion-baseline-${Date.now()}.json`,document.body.appendChild(c),c.click(),setTimeout(()=>{URL.revokeObjectURL(n),c.remove()},0)}catch{}b({title:"Baseline captured",status:"success",duration:2500})}catch(t){b({title:"Baseline failed",description:t.message,status:"error"})}finally{R(!1)}}return e.jsxs(d,{children:[ce,e.jsx(fe,{in:!N,animateOpacity:!0,children:e.jsx(d,{maxH:"50vh",overflow:"auto",p:4,children:e.jsxs(H,{align:"stretch",spacing:4,children:[e.jsxs(d,{children:[e.jsxs(me,{columns:[1,2,3,6],spacing:3,alignItems:"flex-start",mb:3,minChildWidth:"150px",children:[e.jsxs(d,{children:[e.jsx(u,{fontSize:"xs",mb:1,color:"gray.900",children:"Sizes (rows CSV)"}),e.jsx(I,{size:"sm",value:M,onChange:s=>J(s.target.value),placeholder:"1000,5000,10000",bg:"gray.100",_hover:{bg:"gray.600"}})]}),e.jsxs(d,{children:[e.jsx(u,{fontSize:"xs",mb:1,color:"gray.900",children:"Intra Dup Fraction"}),e.jsx(I,{size:"sm",value:w,onChange:s=>V(s.target.value),bg:"gray.100",_hover:{bg:"gray.600"}})]}),e.jsxs(d,{children:[e.jsx(u,{fontSize:"xs",mb:1,color:"gray.900",children:"Existing Dup Fraction"}),e.jsx(I,{size:"sm",value:C,onChange:s=>W(s.target.value),bg:"gray.100",_hover:{bg:"gray.600"}})]}),e.jsxs(d,{children:[e.jsx(u,{fontSize:"xs",mb:1,color:"gray.900",children:"Iterations"}),e.jsx(I,{size:"sm",value:k,onChange:s=>G(s.target.value),bg:"gray.100",_hover:{bg:"gray.600"}})]}),e.jsxs(d,{children:[e.jsx(u,{fontSize:"xs",mb:1,color:"gray.900",children:"Seed Label"}),e.jsx(I,{size:"sm",value:E,onChange:s=>K(s.target.value),placeholder:"BENCH",bg:"gray.100",_hover:{bg:"gray.600"}})]}),e.jsx(A,{align:"center",pt:5,children:e.jsx(je,{isChecked:j,onChange:s=>Y(s.target.checked),color:j?"purple.500":"gray.900",colorScheme:"purple",size:"md",children:"Stream Sim"})})]}),e.jsxs(x,{spacing:3,flexWrap:"wrap",children:[e.jsx(y,{size:"sm",colorScheme:"purple",onClick:de,isDisabled:h,children:"Run"}),e.jsx(y,{size:"sm",leftIcon:e.jsx(be,{}),variant:"outline",borderColor:"gray.900",onClick:le,isDisabled:h,children:"Reset"}),e.jsx(y,{size:"sm",leftIcon:e.jsx(Se,{}),variant:"outline",borderColor:"gray.900",onClick:ue,isDisabled:!v.length||h,children:"Export JSON"}),e.jsx(y,{size:"sm",variant:"outline",borderColor:"gray.900",onClick:pe,isDisabled:h,children:"Capture Baseline"}),m.length>0&&e.jsx(y,{size:"sm",variant:"outline",borderColor:"gray.900",onClick:()=>{L([]),Q([]),b({title:"Baselines cleared",status:"info",duration:1500})},isDisabled:h,children:"Clear Baselines"}),e.jsx(u,{fontSize:"xs",color:"gray.800",children:"Configure and Run synthetic benchmark; results aggregate below."})]})]}),e.jsx(ye,{borderColor:"gray.600"}),e.jsxs(d,{children:[e.jsx(U,{size:"xs",mb:2,color:"gray.800",children:"Results"}),!v.length&&!h&&e.jsx(u,{fontSize:"xs",color:"gray.500",children:"No results yet."}),e.jsxs(H,{spacing:2,align:"stretch",children:[v.map(s=>{const r=Math.round(s.duplicatesRatio);return e.jsx(d,{p:2,bg:"gray.700",borderRadius:"md",border:"1px solid",borderColor:"gray.600",children:e.jsxs(A,{justify:"space-between",flexWrap:"wrap",gap:2,children:[e.jsxs(x,{spacing:2,children:[e.jsxs(f,{colorScheme:"purple",children:[s.size," rows"]}),e.jsx(f,{colorScheme:s.streamSim?"yellow":"blue",children:s.streamSim?"STREAM-SIM":"SYNC"}),e.jsxs(f,{colorScheme:"teal",children:[s.rowsPerSec.toFixed(1)," r/s"]}),e.jsxs(f,{colorScheme:"pink",children:["dup ",r,"%"]})]}),e.jsxs(x,{spacing:3,fontSize:"xs",color:"gray.300",children:[e.jsxs(u,{children:["wall ",s.wallMs,"ms"]}),e.jsxs(u,{children:["ingest ",s.ingestMs,"ms"]}),e.jsxs(u,{children:["proc ",s.processMs,"ms"]}),s.stageTimings?.normalizeMs!==void 0&&e.jsx(B,{label:`early short-circuits: ${s.earlyShortCircuits?.total||0}`,children:e.jsxs(u,{children:["norm ",s.stageTimings.normalizeMs.toFixed(1),"ms"]})})]})]})},s.id)}),m.length>0&&e.jsxs(d,{mt:4,p:2,border:"1px solid",borderColor:"gray.600",borderRadius:"md",bg:"gray.800",children:[e.jsxs(U,{size:"xs",mb:2,color:"gray.200",children:["Baselines (",m.length,")"]}),e.jsx(H,{spacing:2,align:"stretch",maxH:"150px",overflow:"auto",children:m.map((s,r)=>e.jsxs(d,{p:2,bg:"gray.700",borderRadius:"sm",children:[e.jsx(u,{fontSize:"xs",color:"gray.300",children:s.at}),e.jsx(x,{spacing:2,wrap:"wrap",mt:1,children:Object.entries(s.sizes).map(([t,n])=>e.jsx(B,{label:`dup ${n.duplicatesRatio}% rows/s ${n.rowsPerSec}`,children:e.jsxs(f,{colorScheme:"purple",children:[t,"r ",n.wallMs,"ms"]})},t))})]},r))}),m.length>=2&&e.jsxs(d,{mt:3,p:2,border:"1px solid",borderColor:"gray.600",borderRadius:"sm",bg:"gray.700",children:[e.jsxs(x,{spacing:2,mb:2,align:"flex-end",wrap:"wrap",children:[e.jsxs(d,{children:[e.jsx(u,{fontSize:"8px",color:"gray.300",mb:1,children:"Snapshot A"}),e.jsxs("select",{value:O,onChange:s=>oe(s.target.value),style:{fontSize:"0.65rem"},children:[e.jsx("option",{value:"",children:"--"}),m.map(s=>e.jsx("option",{value:s.at,children:s.at},s.at))]})]}),e.jsxs(d,{children:[e.jsx(u,{fontSize:"8px",color:"gray.300",mb:1,children:"Snapshot B"}),e.jsxs("select",{value:F,onChange:s=>ae(s.target.value),style:{fontSize:"0.65rem"},children:[e.jsx("option",{value:"",children:"--"}),m.map(s=>e.jsx("option",{value:s.at,children:s.at},s.at))]})]}),e.jsx(y,{size:"xs",variant:"outline",colorScheme:"purple",onClick:ie,isDisabled:!O||!F,children:"Diff"})]}),q&&e.jsx(d,{maxH:"140px",overflow:"auto",fontFamily:"mono",fontSize:"9px",children:Object.entries(q).sort((s,r)=>Number(s[0])-Number(r[0])).map(([s,r])=>e.jsxs(d,{mb:2,children:[e.jsxs(u,{fontWeight:"bold",color:"purple.200",children:[s," rows"]}),Object.entries(r).map(([t,n])=>n?e.jsxs(u,{color:n.deltaPct!=null?n.deltaPct<0?"green.300":"red.300":"gray.300",children:[t,": ",n.a??"—"," → ",n.b??"—"," ",n.deltaPct!=null?`(${n.deltaPct>0?"+":""}${n.deltaPct}%)`:""]},t):null)]},s))})]})]})]})]})]})})})]})}export{He as default};
