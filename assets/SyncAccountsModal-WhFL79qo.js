import{u as a,k as rt,j as t,M as ct,l as lt,p as ut,q as dt,r as pt,s as b,B as S,t as p,v as mt,i as w}from"./index-xwMjE7XY.js";import{r as u}from"./recharts-fUgtte1b.js";import{I as gt,P as ht}from"./IngestionMetricsPanel-Csc5pPPM.js";import{S as xt,r as St}from"./runIngestion-B6P9gsVO.js";import{M as ft}from"./modal-close-button-V6F9r3JT.js";import{R as jt,a as N}from"./radio-BNrj3pDp.js";import{I as B}from"./input-QV5FdPZP.js";import{S as f,a as j,b as C}from"./stat-number-O1IGy_6B.js";import{T as Ct}from"./AccountsTrackerPage-Dy7munrn.js";import"./stat-help-text-LexhNEvj.js";import"./tooltip-DWNPoC6y.js";import"./create-icon-DM1WmCyW.js";import"./use-event-listener-BvnzY9DD.js";import"./omit-QLD0Eizt.js";import"./accountUtils-C7DJjkh9.js";import"./visually-hidden.style-Bfr07Aua.js";import"./use-form-control-B6IaQYr4.js";import"./split-CzYrjwZo.js";import"./tab-panels-hxep4z5W.js";import"./__vite-browser-external-3a0vqkmD.js";import"./badge-f7PBaRE6.js";import"./tr-BC_ZfAu1.js";import"./center-CIAJU8Ix.js";import"./LoadingSpinner-BAAFQNyv.js";function Ht({isOpen:G,onClose:A}){const X=a(e=>e.accountMappings),_=a(e=>e.setAccountMapping),[c,O]=u.useState("csv"),[v,M]=u.useState(null),[D,F]=u.useState(null),[g,E]=u.useState("import"),[U,P]=u.useState([]),[q,T]=u.useState([]),[J,z]=u.useState({}),[W,L]=u.useState(!1),[d,$]=u.useState([]),[r,Q]=u.useState(null),[y,V]=u.useState(""),Y=a(e=>e.setLastIngestionTelemetry),K=a(e=>e.recordImportHistory),Z=a(e=>e.addPendingSavingsQueue),tt=a.setState,m=rt(),H=["csv","ofx"],et=a(e=>e.isDemoUser),k=()=>{O("csv"),M(null),F(null),E("import"),P([]),T([]),z({})},st=e=>{c==="csv"?(M(e.target.files[0]),F(null)):c==="ofx"&&(F(e.target.files[0]),M(null))},nt=()=>{if(!v&&!D){m({title:`Please select a ${c.toUpperCase()} file`,status:"warning",duration:3e3});return}c==="csv"?ht.parse(v,{header:!0,skipEmptyLines:!0,complete:e=>{const s=e.data,i=new Set(s.map(o=>o.AccountNumber?.trim()).filter(Boolean)),n=Array.from(i).filter(o=>!X[o]);if(n.length>0){P(n),T(s),E("mapping");return}a.getState().accountMappings,R(s)},error:e=>{m({title:"CSV Parse Failed",description:e.message,status:"error",duration:4e3})}}):c==="ofx"&&m({title:"OFX File Import Coming Soon, please use CSV for now.",status:"warning",duration:3e3})},R=async e=>{L(!0),$([]),Q(null);try{const s=e.reduce((o,h)=>{const x=(h.AccountNumber||h.accountNumber||"").trim();return x&&(o[x]||(o[x]=[]),o[x].push(h)),o},{}),i=[];let n={accounts:0,rows:0,newCount:0,dupesExisting:0,dupesIntraFile:0,savings:0};for(const o of Object.keys(s)){const h=s[o];n.accounts++,n.rows+=h.length;const x=h.map((l,at)=>({date:l["Posted Date"]||l.Date||l.date,Description:l.Description||l.description||l.Memo,Amount:l.Amount??l.amount??l.Amt??l.amt,Category:l.Category||l.category,__line:at+1})),ot=a.getState().accounts[o]?.transactions||[],I=await St({parsedRows:{rows:x,errors:[]},accountNumber:o,existingTxns:ot,registerManifest:a.getState().registerImportManifest});i.push({accountNumber:o,result:I}),n.newCount+=I.stats.newCount,n.dupesExisting+=I.stats.dupesExisting,n.dupesIntraFile+=I.stats.dupesIntraFile,n.savings+=I.savingsQueue?.length||0}$(i),i.length&&!y&&V(i[0].accountNumber),Q(n),m({title:"Dry run complete",description:`Accounts: ${n.accounts} New: ${n.newCount} DupEx: ${n.dupesExisting} DupIntra: ${n.dupesIntraFile}`,status:"info",duration:4e3})}catch(s){m({title:"Ingestion failed",description:s.message,status:"error"})}finally{L(!1)}},it=()=>{if(d.length)try{d.forEach(({accountNumber:e,result:s})=>{if(!s?.patch)return;tt(s.patch),K({sessionId:s.stats.importSessionId,accountNumber:e,importedAt:new Date().toISOString(),newCount:s.stats.newCount,dupesExisting:s.stats.dupesExisting,dupesIntraFile:s.stats.dupesIntraFile,savingsCount:s.savingsQueue?.length||0,hash:s.stats.hash}),s.savingsQueue?.length&&Z(e,s.savingsQueue);const i=a.getState().accountMappings?.[e];i&&a.getState().addOrUpdateAccount(e,{accountNumber:e,id:a.getState().accounts[e]?.id||crypto.randomUUID(),label:i.label||e,institution:i.institution||"Unknown",lastSync:new Date().toISOString()});const n=s.stats.importSessionId;m({position:"bottom-right",duration:6e3,render:({onClose:o})=>t.jsxs(w,{p:3,bg:"gray.800",color:"white",borderRadius:"md",boxShadow:"md",children:[t.jsxs(p,{fontSize:"sm",mb:1,children:["Imported ",s.stats.newCount," new tx in ",e]}),t.jsx(S,{size:"xs",colorScheme:"red",variant:"outline",onClick:()=>{a.getState().undoStagedImport(e,n),o()},children:"Undo"})]})})}),r&&Y({at:new Date().toISOString(),accountNumber:r.accounts>1?`${r.accounts} accounts`:d[0]?.accountNumber,newCount:r.newCount,dupesExisting:r.dupesExisting,dupesIntraFile:r.dupesIntraFile,categorySources:null}),m({title:"Import applied (staged)",description:"Transactions are staged until you Apply to Budget.",status:"success",duration:3500}),A(),k()}catch(e){m({title:"Apply failed",description:e.message,status:"error"})}};return t.jsxs(ct,{isOpen:G,onClose:()=>{A(),k()},size:"lg",children:[t.jsx(lt,{}),t.jsxs(ut,{children:[t.jsx(dt,{children:g==="import"?"Sync Your Accounts":"Map Account Numbers"}),t.jsx(ft,{}),t.jsxs(pt,{children:[g==="import"&&t.jsxs(b,{spacing:4,children:[et&&t.jsxs(t.Fragment,{children:[t.jsx(S,{size:"sm",variant:"outline",onClick:()=>{const e=[{AccountNumber:"1234",AccountType:"Checking","Posted Date":"2025-08-03",Description:"Woodmans Grocery",Category:"groceries",Amount:"-89.12"},{AccountNumber:"1234",AccountType:"Checking","Posted Date":"2025-08-05",Description:"Direct Deposit",Category:"income",Amount:"1200.00"},{AccountNumber:"1234",AccountType:"Checking","Posted Date":"2025-08-09",Description:"Web Branch:TFR TO SV 457397801",Category:"transfer",Amount:"-100.00"}],s=[...new Set(e.map(o=>o.AccountNumber?.trim()).filter(Boolean))],i=a.getState().accountMappings,n=s.filter(o=>!i[o]);n.length?(P(n),T(e),E("mapping")):R(e)},children:"Load Sample CSV (Demo)"}),t.jsx(p,{fontSize:"sm",color:"gray.500",align:"center",children:"-- OR --"})]}),t.jsx(jt,{value:c,onChange:O,children:t.jsxs(b,{direction:"column",children:[t.jsx(N,{value:"csv",children:"CSV File"}),t.jsx(N,{value:"ofx",children:"OFX File (Coming Soon)"}),t.jsx(N,{value:"plaid",isDisabled:!0,children:"Bank Account (Coming Soon)"})]})}),H.includes(c)&&t.jsxs(t.Fragment,{children:[t.jsx(B,{type:"file",accept:`.${c}`,onChange:st}),(c==="csv"&&v||c==="ofx"&&D)&&t.jsxs(p,{fontSize:"sm",color:"gray.500",children:["Selected: ",c==="csv"?v?.name:D?.name]})]})]}),g==="mapping"&&t.jsxs(b,{spacing:4,children:[t.jsx(p,{mb:2,children:"We found account numbers that aren't yet mapped. Please assign a label and institution."}),U.map(e=>t.jsxs(b,{spacing:2,children:[t.jsxs(p,{fontWeight:"bold",children:["Account #: ",e]}),t.jsx(B,{placeholder:"Label (e.g., Jr's Checking)",onChange:s=>z(i=>({...i,[e]:{...i[e],label:s.target.value}}))}),t.jsx(B,{placeholder:"Institution (e.g., UWCU)",onChange:s=>z(i=>({...i,[e]:{...i[e],institution:s.target.value}}))})]},e))]})]}),t.jsxs(mt,{children:[g==="import"?t.jsxs(t.Fragment,{children:[t.jsx(S,{onClick:()=>{A(),k()},variant:"ghost",mr:3,children:"Cancel"}),t.jsx(S,{onClick:nt,colorScheme:"teal",isLoading:W,isDisabled:!H.includes(c),children:d.length?"Re-Import":"Import"})]}):t.jsx(S,{colorScheme:"teal",onClick:()=>{U.forEach(e=>{const s=J[e]||{};_(e,{label:s.label||e,institution:s.institution||"Unknown"})}),a.getState().accountMappings,R(q)},children:"Save & Continue Import"}),g==="import"&&d.length>0&&!W&&t.jsxs(S,{ml:3,colorScheme:"purple",onClick:it,children:["Apply All (",r?.newCount||0," new)"]})]}),g==="import"&&d.length>0&&t.jsxs(w,{px:6,pb:4,children:[t.jsx(p,{fontSize:"sm",fontWeight:"bold",mb:2,children:"Dry Run Summary"}),t.jsxs(xt,{columns:{base:2,md:4},spacing:3,mb:3,fontSize:"xs",children:[t.jsxs(f,{children:[t.jsx(j,{children:"Accounts"}),t.jsx(C,{fontSize:"md",children:r?.accounts})]}),t.jsxs(f,{children:[t.jsx(j,{children:"Rows"}),t.jsx(C,{fontSize:"md",children:r?.rows})]}),t.jsxs(f,{children:[t.jsx(j,{children:"New"}),t.jsx(C,{fontSize:"md",children:r?.newCount})]}),t.jsxs(f,{children:[t.jsx(j,{children:"DupEx"}),t.jsx(C,{fontSize:"md",children:r?.dupesExisting})]}),t.jsxs(f,{children:[t.jsx(j,{children:"DupIntra"}),t.jsx(C,{fontSize:"md",children:r?.dupesIntraFile})]}),t.jsxs(f,{children:[t.jsx(j,{children:"Savings"}),t.jsx(C,{fontSize:"md",children:r?.savings})]})]}),t.jsx(w,{maxH:"140px",overflow:"auto",borderWidth:"1px",borderRadius:"md",p:2,fontSize:"11px",children:d.map(({accountNumber:e,result:s})=>t.jsxs(w,{mb:2,children:[t.jsx(p,{fontWeight:"bold",children:e}),t.jsxs(p,{children:["New: ",s.stats.newCount," | DupEx: ",s.stats.dupesExisting," | DupIntra: ",s.stats.dupesIntraFile," | EarlySC: ",s.stats.earlyShortCircuits?.total]})]},e))}),t.jsxs(w,{mt:4,children:[t.jsxs(b,{direction:"row",align:"center",mb:2,spacing:2,children:[t.jsx(p,{fontSize:"sm",children:"Metrics:"}),t.jsx("select",{value:y,onChange:e=>V(e.target.value),style:{fontSize:"0.75rem"},children:d.map(e=>t.jsx("option",{value:e.accountNumber,children:e.accountNumber},e.accountNumber))}),y&&t.jsx(Ct,{size:"sm",children:y.slice(0,12)})]}),(()=>{const e=d.find(n=>n.accountNumber===y)||d[0];if(!e)return null;const s=e.result.stats,i={ingestMs:s.ingestMs,parseMs:null,processMs:s.processMs,totalMs:s.ingestMs,rowsProcessed:s.rowsProcessed,rowsPerSec:s.rowsPerSec,duplicatesRatio:s.duplicatesRatio,stageTimings:s.stageTimings,earlyShortCircuits:s.earlyShortCircuits};return t.jsx(gt,{metrics:i,sessionId:s.importSessionId})})()]})]})]})]})}export{Ht as default};
